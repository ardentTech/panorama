package codegen

import com.squareup.kotlinpoet.FileSpec
import com.squareup.kotlinpoet.TypeSpec
import lexicon.*
import java.nio.file.Path
import java.util.*
import kotlin.io.path.Path

fun SchemaDef.codegen(name: String): List<TypeSpec> {
    return when (this) {
        is LexiconObject -> listOf(this.codegen(name)) // TODO hmmm needs a `defs` type to wrap multiple objects?
        is LexiconProcedure -> this.codegen(name)
        is LexiconQuery -> this.codegen(name)
        // TODO object, query, record, subscription...
        else -> emptyList()
    }
}

fun LexiconDoc.codegen(destination: Path) {
    var description: String? = null
    val rootName = this.id.split(".").last().capitalize()
    val specs = mutableListOf<TypeSpec>()

    this.defs.forEach { (name, def) ->
        println("def: $name")
        specs += def.codegen(
            if (name == "main") rootName
            else if (rootName == "Defs") name.capitalize()
            else "$rootName${name.capitalize()}")
        if (name == "main") description = def.description
    }

    if (specs.isNotEmpty()) {
        // TODO FileSpec package name
        val file = FileSpec.builder("", rootName)
            .addFileComment("""
This file was generated by Panorama. DO NOT EDIT.

Lexicon: ${this.id}
${description?.let { "Description: $it" }}
                        """.trimIndent())
        // TODO build dirs to match package name
        specs.forEach { file.addType(it) }
        // TODO return spec instead of writing file here
        file.build().writeTo(destination)
    }
}